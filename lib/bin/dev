#!/bin/bash
readonly ScriptVersion="0.2"
readonly PROGDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
readonly HOMEDIR=$(echo $HOME)
readonly PROGNAME=$(basename $0)
readonly LOG_FILE=$PROGDIR/../../logs/dev.error.log
readonly DOTFILES=$PROGDIR/../dotfiles
readonly PATCHES=$PROGDIR/../patches
readonly INSTALL_DIR=$PROGDIR/../install
readonly CONFIG_DIR=$PROGDIR/../config
readonly ARGS="$@"
readonly GITDIR=/home/git
readonly NGINX_DIR=/etc/nginx
readonly g=/usr/bin/git
exec 3>&1 1>>${LOG_FILE} 2>&1;

function command_exists () {
    type "$1" &> /dev/null ;
}
function install_homebrew () {
    echo -e "\ndev: Installing Homebrew" 1>&3;
    ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)" | tee /dev/fd/3;
    brew tap phinze/homebrew-cask
    brew install brew-cask
}
function sync_dotfiles () {
  # Sync Dotfiles
  rsync --exclude ".DS_Store" --exclude "README.md" -av --no-perms $DOTFILES/ ~ | tee /dev/fd/3
}
function gem_install () {
  if command_exists bundle; then
      echo -e "\ndev: Bundler Installed... continuing" 1>&3;
  else
      sudo gem install bundler | tee /dev/fd/3;
  fi
  bundle install | tee /dev/fd/3;
}
function npm_install () {
    # install node modules
    sudo npm cache clean;
    function installGlobal() {
      # TODO: improve this to work all 
      if command_exists "${@}"; then
          echo -e "dev: ${@}:" $("${@}" "--version") 1>&3;
      else
          sudo npm install -g "${@}" | tee /dev/fd/3;
      fi
    }
    installGlobal bower
    installGlobal forever
    installGlobal node-inspector
    installGlobal ohm
    installGlobal grunt-cli
    installGlobal coffee-script
    installGlobal strong-cli
    npm ls -g --depth=0 1>&3;
}
#---------------#
# Sync Dotfiles #
#---------------#
echo -e "\ndev: Preparing to sync Dotfiles..."  1>&3;
echo -e "\nwarn: This may overwrite existing files in your home directory. Are you sure? [y/n]" 1>&3;
read -n 1;
if [[ $REPLY =~ ^[Yy]$ ]]; then
    sync_dotfiles
fi
#------------------#
# Install Homebrew #
#------------------#
if command_exists brew ; then
    echo -e "\ndev: Brew Installed... updating" 1>&3;
    brew update 1>&3;
    brew upgrade 1>&3;
    brew cask doctor 1>&3;
    brew doctor 1>&3;
else
    install_homebrew
fi
#------------------#
# Homebrew bundle  #
#------------------#
echo -e " \ndev: Install Applications via Homebrew & Cask? [y/n] " 1>&3;
read -n 1
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "\ndev: installing GUIs and CLIs via Homebrew... " 1>&3;
    brew bundle $PROGDIR/brew | tee /dev/fd/3;
fi
#------------------------#
# Npm globals & Gemfile  #
#------------------------#
echo -e "\ndev: Do you want to install Gems and Npm modules? [y/n] " 1>&3;
read -n 1
if [[ $REPLY =~ ^[Yy]$ ]]; then
    gem_install
    npm_install
fi
unset command_exists
unset install_homebrew
unset sync_dotfiles
unset gem_install
unset npm_install
exit 0
