#!/bin/bash
readonly ScriptVersion="0.2"
readonly PROGDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
readonly HOMEDIR="$HOME"
readonly PROGNAME=$(basename "$0")
readonly LOG_FILE=$PROGDIR/../../logs/dev.error.log
readonly DOTFILES=$PROGDIR/../dotfiles
readonly PATCHES=$PROGDIR/../patches
readonly INSTALL_DIR=$PROGDIR/../install
readonly CONFIG_DIR=$PROGDIR/../config
readonly ARGS=( "$@" )
readonly GITDIR=/home/git
readonly NGINX_DIR=/etc/nginx
readonly g=/usr/bin/git
readonly gem=/usr/bin/gem
readonly brew=/usr/local/bin/brew
readonly npm=/usr/local/bin/npm

exec 3>&1 1>>"${LOG_FILE}" 2>&1;

function command_exists () {
    type "$1" &> /dev/null ;
}
function install_homebrew () {
    echo -e "\nInstalling Homebrew" 1>&3;
    ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)" | tee /dev/fd/3;
    $brew tap phinze/homebrew-cask 1>&3;
    $brew install brew-cask 1>&3;
    $brew tap homebrew/versions 1>&3;
    $brew tap homebrew/dupes 1>&3;
    $brew tap caskroom/fonts 1>&3;
    $brew tap caskroom/versions 1>&3;
    $brew tap josegonzalez/homebrew-php 1>&3;
}
function sync_dotfiles () {
  # Sync Dotfiles
  rsync --exclude ".DS_Store" --exclude "README.md" --exclude "*#" --exclude "*~" --exclude ".emacs.d/elpa/*" -av --no-perms $DOTFILES/ ~ 1>&3;
}
function gem_install () {
   sudo $gem update --system 1>&3;
   sudo $gem update 1>&3;
  if command_exists bundle; then
      echo -e "\nBundler Installed... continuing" 1>&3;
  else
      sudo $gem install bundler | tee /dev/fd/3;
  fi
  bundle install | tee /dev/fd/3;
}
function npm_install () {
    # install node modules
    sudo $npm cache clean 1>&3;
    $npm update $npm -g 1>&3;
    sudo $npm update -g 1>&3;
    
    function installGlobal() {
      # TODO: improve this to work all 
      if command_exists "${@}"; then
          echo -e "${@}:" $("${@}" "--version") 1>&3;
      else
          sudo $npm install -g "${@}" | tee /dev/fd/3;
      fi
    }
    installGlobal bower
    installGlobal forever
    installGlobal node-inspector
    installGlobal ohm
    installGlobal grunt-cli
    installGlobal coffee-script
    $npm ls -g --depth=0 1>&3;
}
# OS X Software Updates
sudo softwareupdate -i -a 1>&3;
####################
# Dotfiles         #
####################
echo -e "\nPreparing to sync Dotfiles..."  1>&3;
echo -e "\nThis may overwrite existing files in your home directory. Are you sure? [y/n]" 1>&3;
read -n 1;
if [[ $REPLY =~ ^[Yy]$ ]]; then
    sync_dotfiles
fi
####################
# Homebrew         #
####################
if command_exists brew ; then
    echo -e "\nBrew Installed..." 1>&3;
else
    install_homebrew
fi
echo -e " \nInstall Applications via Homebrew & Cask? [y/n] " 1>&3;
read -n 1
if [[ $REPLY =~ ^[Yy]$ ]]; then
    "$PROGDIR"/brew 1>&3;
fi
####################
# Npm & Gem        #
####################
echo -e "\nDo you want to install Gems and Npm modules? [y/n] " 1>&3;
read -n 1
if [[ $REPLY =~ ^[Yy]$ ]]; then
    gem_install
    npm_install
fi
unset command_exists
unset install_homebrew
unset sync_dotfiles
unset gem_install
unset npm_install
exit 0
